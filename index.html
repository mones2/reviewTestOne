<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Share Your Experience</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    /* ============== CONFIG ============== */
    const CONFIG = {
      serviceName: "ReviewFlow",
      restaurantName: "Sahara",
      // Use your exact Google Maps URL (preferred)
      googleMapsUrl: "https://www.google.com/maps/place/Sahara+Restaurant/@40.5000681,-74.4567202,17z/data=!4m8!3m7!1s0x89c3c6ff3e35125b:0xc9ebce3f3d21e043!8m2!3d40.5000681!4d-74.4541453!9m1!1b1!16s%2Fg%2F1tczldzb?hl=en-US&entry=ttu&g_ep=EgoyMDI1MDgyNC4wIKXMDSoASAFQAw%3D%3D",
      // Optional fallback if you ever want to use Place ID instead
      googlePlaceId: "",
      negativeFeedbackEndpoint: "", // if set, we'll POST negative feedback JSON
      brandPrimary: "#b91c1c",
      locale: "en",
      useEmojis: true,

      /* Optional AI polish (LOCAL TESTING ONLY). Do NOT deploy secrets client-side. */
      aiApiKey: "", // e.g. "gsk_..."; leave empty for production unless proxied
      aiModel: "meta-llama/llama-4-scout-17b-16e-instruct"
    };
  </script>
  <style>
    :root { --brand: #b91c1c; --brand-50:#fee2e2; --brand-600:#b91c1c; --brand-700:#991b1b; }
    .brand-bg { background-color: var(--brand) }
    .brand-txt{ color: var(--brand) }
    .brand-ring{ --tw-ring-color: var(--brand) }
    .smooth  { transition: all 220ms ease }
    .tooltip:focus .tooltip-panel, .tooltip:hover .tooltip-panel { opacity:1; transform: translateY(0) }
    .tooltip-panel { opacity:0; transform: translateY(2px) }
  </style>
</head>

<body class="min-h-screen bg-gradient-to-br from-stone-50 to-stone-200 text-slate-800 antialiased">
  <main class="mx-auto max-w-3xl px-4 py-10">
    <section class="mx-auto max-w-2xl rounded-2xl bg-white shadow-xl ring-1 ring-black/5 smooth">
      <!-- Header -->
      <header class="p-6 sm:p-8 border-b border-slate-100">
        <h1 class="text-2xl sm:text-3xl font-semibold tracking-tight">
          Share your experience at <span class="brand-txt" id="brandName"></span>
        </h1>
      </header>

      <!-- Content -->
      <div class="p-6 sm:p-8 space-y-8">

        <!-- Experience -->
        <section id="experience" role="region" aria-labelledby="exp-title">
          <h2 id="exp-title" class="text-xl sm:text-2xl font-semibold">How was your experience today?</h2>
          <div class="mt-6 grid grid-cols-1 sm:grid-cols-3 gap-3">
            <button type="button" data-exp="Excellent"
              class="group w-full rounded-xl border border-slate-200 bg-white px-4 py-5 text-left shadow-sm hover:shadow-md focus:outline-none focus-visible:ring-2 brand-ring smooth"
              aria-label="Excellent">
              <div class="text-2xl" aria-hidden="true">ü§©</div>
              <div class="mt-1 text-base font-medium">Excellent</div>
              <p class="text-sm text-slate-500">Everything sang.</p>
            </button>

            <button type="button" data-exp="Good"
              class="group w-full rounded-xl border border-slate-200 bg-white px-4 py-5 text-left shadow-sm hover:shadow-md focus:outline-none focus-visible:ring-2 brand-ring smooth"
              aria-label="Good">
              <div class="text-2xl" aria-hidden="true">üôÇ</div>
              <div class="mt-1 text-base font-medium">Good</div>
              <p class="text-sm text-slate-500">Worth sharing.</p>
            </button>

            <button type="button" data-exp="Not great"
              class="group w-full rounded-xl border border-slate-200 bg-white px-4 py-5 text-left shadow-sm hover:shadow-md focus:outline-none focus-visible:ring-2 brand-ring smooth"
              aria-label="Not great">
              <div class="text-2xl" aria-hidden="true">üòï</div>
              <div class="mt-1 text-base font-medium">Not great</div>
              <p class="text-sm text-slate-500">Tell us why.</p>
            </button>
          </div>
        </section>

        <!-- POSITIVE: keywords + highlight + review + actions -->
        <section id="positive" class="hidden" role="region" aria-labelledby="pos-title" aria-hidden="true">
          <h2 id="pos-title" class="text-xl sm:text-2xl font-semibold">Craft your review</h2>

          <!-- Keywords (chips like your screenshot, but cleaner) -->
          <div class="mt-4">
            <div class="flex items-center justify-between">
              <label class="block text-sm font-medium text-slate-700">Pick a few keywords</label>
              <button id="toggleMoreTags" type="button"
                class="text-sm text-slate-600 hover:text-slate-800 focus:outline-none focus-visible:ring-2 brand-ring rounded-md px-2 py-1 smooth">
                Show more
              </button>
            </div>
            <p class="mt-1 text-sm text-slate-500">Choose up to 3. Pulled from the menu.</p>

            <div id="tagWrap" class="mt-3 flex flex-wrap gap-2"></div>
          </div>

          <!-- Highlight -->
          <div class="mt-6">
            <p class="text-sm font-medium text-slate-700">What stood out the most?</p>
            <div class="mt-3 flex flex-wrap gap-2">
              <button type="button" class="hl smooth rounded-full border px-3 py-1 text-sm border-slate-300 text-slate-700 hover:bg-slate-50 focus:outline-none focus-visible:ring-2 brand-ring" data-hl="Food">üçΩ Food</button>
              <button type="button" class="hl smooth rounded-full border px-3 py-1 text-sm border-slate-300 text-slate-700 hover:bg-slate-50 focus:outline-none focus-visible:ring-2 brand-ring" data-hl="Service">ü§ù Service</button>
              <button type="button" class="hl smooth rounded-full border px-3 py-1 text-sm border-slate-300 text-slate-700 hover:bg-slate-50 focus:outline-none focus-visible:ring-2 brand-ring" data-hl="Atmosphere">üåÜ Atmosphere</button>
              <button type="button" class="hl smooth rounded-full border px-3 py-1 text-sm border-slate-300 text-slate-700 hover:bg-slate-50 focus:outline-none focus-visible:ring-2 brand-ring" data-hl="Authenticity">üåç Authenticity</button>
            </div>
          </div>

          <!-- Review -->
          <div class="mt-6">
            <div class="flex items-center justify-between">
              <label for="reviewText" class="text-sm font-medium text-slate-700">Your review</label>
              <label class="inline-flex items-center gap-2 cursor-pointer">
                <input id="editToggle" type="checkbox" class="h-4 w-4 rounded border-slate-300 text-[var(--brand)] focus:ring-[var(--brand)]" />
                <span class="text-sm text-slate-700">Enable editing</span>
              </label>
            </div>

            <textarea id="reviewText" rows="6" readonly
              class="mt-2 w-full rounded-xl border border-slate-300 focus:border-slate-400 focus:ring-2 brand-ring p-4 text-[15px] leading-6"
              aria-describedby="copyHelp"></textarea>
            <p id="copyHelp" class="mt-2 text-sm text-slate-500">Copy and paste to Google, or try AI polish.</p>

            <div class="mt-3 flex items-center gap-3">
              <button id="copyBtn" type="button"
                class="rounded-lg px-4 py-2 text-white brand-bg hover:brightness-95 focus:outline-none focus-visible:ring-2 brand-ring smooth"
                aria-label="Copy review">Copy</button>
              <span id="copyStatus" class="text-sm text-slate-600" aria-live="polite"></span>
            </div>
          </div>

          <!-- Actions -->
          <div class="mt-6 grid grid-cols-1 sm:grid-cols-2 gap-3">
            <div class="relative inline-block tooltip">
              <a id="googleLink" target="_blank" rel="noopener noreferrer"
                 class="inline-flex w-full items-center justify-center rounded-lg px-4 py-3 text-white brand-bg hover:brightness-95 focus:outline-none focus-visible:ring-2 brand-ring smooth disabled:opacity-40 disabled:pointer-events-none"
                 aria-label="Open Google to post">
                ‚≠ê <span class="ml-2">Open Google to post</span>
              </a>
              <div id="googleTip" class="tooltip-panel pointer-events-none absolute left-1/2 -translate-x-1/2 mt-2 w-max max-w-xs rounded-md bg-slate-900 px-3 py-2 text-[12px] text-white shadow-lg">
                Add a Google Maps URL or Place ID.
              </div>
            </div>

            <div class="relative inline-block tooltip">
              <button id="aiPolishBtn" type="button"
                class="inline-flex w-full items-center justify-center rounded-lg px-4 py-3 text-[var(--brand)] border border-[var(--brand)] hover:bg-[var(--brand)] hover:text-white focus:outline-none focus-visible:ring-2 brand-ring smooth"
                aria-label="Polish with AI">‚ú® <span class="ml-2">Polish with AI</span>
              </button>
              <div id="aiTip" class="tooltip-panel pointer-events-none absolute left-1/2 -translate-x-1/2 mt-2 w-max max-w-xs rounded-md bg-slate-900 px-3 py-2 text-[12px] text-white shadow-lg">
                Add an AI key in CONFIG.aiApiKey (local testing only).
              </div>
            </div>
          </div>

          <div id="aiStatus" class="mt-3 text-sm text-slate-600" aria-live="polite"></div>

          <div class="mt-6">
            <button id="startOverPositive" type="button"
              class="rounded-lg border border-slate-300 px-4 py-2 text-slate-700 hover:bg-slate-50 focus:outline-none focus-visible:ring-2 brand-ring smooth"
              aria-label="Start over">Start over</button>
          </div>
        </section>

        <!-- NEGATIVE: simpler -->
        <section id="negative" class="hidden" role="region" aria-labelledby="neg-title" aria-hidden="true">
          <div class="text-center">
            <div class="text-4xl" aria-hidden="true">üôè</div>
            <h2 id="neg-title" class="mt-3 text-xl sm:text-2xl font-semibold">Thank you for your honesty.</h2>
            <p class="mt-2 text-slate-600">What could we improve?</p>
          </div>

          <div class="mt-5 space-y-4">
            <div>
              <label for="negReason" class="text-sm font-medium text-slate-700">Your feedback <span class="text-rose-600">*</span></label>
              <textarea id="negReason" rows="4" class="mt-2 w-full rounded-xl border border-slate-300 focus:border-slate-400 focus:ring-2 brand-ring p-3" required></textarea>
            </div>

            <div class="flex items-center gap-3">
              <button id="sendNegative" type="button"
                class="rounded-lg px-4 py-2 text-white brand-bg hover:brightness-95 focus:outline-none focus-visible:ring-2 brand-ring smooth"
                aria-label="Send to restaurant">Send</button>
              <button id="startOverNegative" type="button"
                class="rounded-lg border border-slate-300 px-4 py-2 text-slate-700 hover:bg-slate-50 focus:outline-none focus-visible:ring-2 brand-ring smooth"
                aria-label="Start over">Start over</button>
              <span id="negStatus" class="text-sm text-slate-600" aria-live="polite"></span>
            </div>
          </div>
        </section>
      </div>
    </section>
  </main>

  <!-- aria-live region for screen readers -->
  <div id="sr-live" class="sr-only" aria-live="polite"></div>

  <script>
    /* Brand color from CONFIG */
    document.documentElement.style.setProperty("--brand", CONFIG.brandPrimary);

    /* MENU (for keyword extraction only; prices intentionally unused/hidden) */
    const MENU = [
      { name:"chicken kebab", description:"Cubes of marinated chicken breast char-broiled on skewers. Served with rice and burgol.", category:"Entr√©es", aliases:["chicken shish"] },
      { name:"adana kebab", description:"Hand diced lamb flavored with fresh red bell peppers, gently spiced with paprika and grilled on skewers. Served with rice and burgol.", category:"Entr√©es", aliases:["adana","lamb adana"] },
      { name:"chicken adana kebab", description:"Ground chicken flavored with fresh red bell peppers and hot peppers, grilled on skewers. Served with rice and burgol.", category:"Entr√©es", aliases:["chicken adana"] },
      { name:"shish kebab", description:"Cubes of marinated lamb char-broiled on skewers. Served with rice and burgol.", category:"Entr√©es", aliases:["lamb shish"] },
      { name:"chicken chops", description:"Skinless, boneless marinated chicken thighs, grilled to perfection. Served with rice and burgol.", category:"Entr√©es", aliases:[] },
      { name:"feta chicken", description:"Saut√©ed chicken breast topped with fresh tomatoes and melted feta cheese, finished with a lemon garlic sauce. Served with vegetables and mashed potato.", category:"Entr√©es", aliases:[] },
      { name:"pyramid chicken", description:"Saut√©ed chicken breast topped with saut√©ed mushrooms, crushed black peppercorns, dijon and a light cream sauce. Served with vegetables and mashed potato.", category:"Entr√©es", aliases:[] },
      { name:"nile chicken", description:"Saut√©ed chicken breast topped with sliced roasted eggplant, roasted red pepper, fresh mozzarella and finished with a pink sauce. Served with vegetables and mashed potato.", category:"Entr√©es", aliases:[] },
      { name:"lamb chops", description:"Select lamb chops specially marinated and char-broiled. Served with rice and burgol.", category:"Entr√©es", aliases:[] },
      { name:"braised beef short ribs", description:"Slow-braised beef short ribs with fresh herbs and a demi-glace sauce. Served over couscous.", category:"Entr√©es", aliases:["short ribs"] },
      { name:"couscous beef and vegetable stew", description:"Braised beef with vegetables in a light tomato sauce. Served over couscous and topped with toasted almonds.", category:"Entr√©es", aliases:["beef stew"] },
      { name:"lamb shank", description:"Slow-braised lamb shank on the bone topped with celery, potato, carrot, and onion in a tomato sauce. Served with couscous.", category:"Entr√©es", aliases:[] },
      { name:"chicken combination platter", description:"Chicken Kebab, Chicken Chops & Chicken Adana. Served with rice and burgol.", category:"Entr√©es", aliases:[] },
      { name:"choice combination kebab", description:"Choose 2 of Adana Kebab, Chicken Adana Kebab, or Chicken Kebab. Served with rice and burgol.", category:"Entr√©es", aliases:[] },
      { name:"sahara mixed grill", description:"Adana Kebab, Chicken Kebab, Chicken Adana Kebab, Chicken Chops and Shish Kebab. Served with rice and burgol.", category:"Entr√©es", aliases:["mixed grill"] },
      { name:"tilapia", description:"Tilapia filet saut√©ed with fresh tomato and capers in a garlic lemon sauce. Served with vegetables and mashed potato.", category:"Seafood Entr√©es", aliases:[] },
      { name:"salmon", description:"Salmon prepared with leeks and fresh tomato, finished with a lemon-garlic sauce. Served with vegetables and mashed potato.", category:"Seafood Entr√©es", aliases:[] },
      { name:"shrimp kebab", description:"Grilled, marinated Jumbo Shrimp served with rice and bihari.", category:"Seafood Entr√©es", aliases:["shrimp"] },
      { name:"sahara shrimp", description:"Shrimp cooked in our spicy tomato sauce. Served with vegetables and mashed potato.", category:"Seafood Entr√©es", aliases:[] },
      { name:"shrimp saut√©", description:"Saut√©ed shrimp with capers and fresh tomato, finished with a light lemon garlic sauce. Served with vegetables and mashed potato.", category:"Seafood Entr√©es", aliases:["shrimp saute"] },
      { name:"couscous vegetable stew", description:"Vegetables in a light tomato sauce, served over couscous and topped with toasted almonds.", category:"Vegetarian Entr√©es", aliases:["vegetable stew"] },
      { name:"roasted eggplant", description:"Eggplant stuffed with rice and fresh vegetables, topped with melted feta cheese.", category:"Vegetarian Entr√©es", aliases:["imam bayildi"] },
      { name:"cauliflower cake", description:"Pan saut√©ed, served with horseradish sauce.", category:"Vegetarian Entr√©es", aliases:[] },
      { name:"falafel (entr√©e)", description:"Fried chickpeas mixed with vegetables. Served with rice and burgol.", category:"Vegetarian Entr√©es", aliases:["falafel entree","felafel"] },
      { name:"stuffed bell pepper (entr√©e)", description:"Bell pepper stuffed with eggplant topped with fresh tomato sauce and shaved parmesan cheese. Served with rice and burgol.", category:"Vegetarian Entr√©es", aliases:["stuffed pepper"] },
      { name:"hummus", description:"", category:"Appetizers", aliases:[] },
      { name:"hummus with spiced ezme", description:"", category:"Appetizers", aliases:["ezme hummus"] },
      { name:"hummus with saksuka", description:"", category:"Appetizers", aliases:["saksuka hummus"] },
      { name:"house hummus", description:"", category:"Appetizers", aliases:[] },
      { name:"chipotle hummus", description:"", category:"Appetizers", aliases:[] },
      { name:"baba ghanoush", description:"", category:"Appetizers", aliases:["baba ganoush"] },
      { name:"eggplant dip", description:"", category:"Appetizers", aliases:[] },
      { name:"labhne", description:"", category:"Appetizers", aliases:["labneh"] },
      { name:"saksuka (eggplant with sauce)", description:"", category:"Appetizers", aliases:["saksuka"] },
      { name:"spiced ezme", description:"", category:"Appetizers", aliases:["ezme"] },
      { name:"falafel (appetizer)", description:"Fried chickpeas mixed with vegetables served with cajik and tahini sauce.", category:"Appetizers", aliases:["felafel"] },
      { name:"stuffed bell pepper (appetizer)", description:"Bell pepper stuffed with eggplant topped with fresh tomato sauce and shaved parmesan cheese.", category:"Appetizers", aliases:[] },
      { name:"sahara vegetarian combination", description:"Spiced ezme, cauliflower dip, hummus, eggplant salad and labhne, topped with olive oil and parsley.", category:"Appetizers", aliases:["vegetarian combo"] },
      { name:"calamari", description:"Fried calamari with house tomato sauce.", category:"Appetizers", aliases:[] },
      { name:"sigara boregi (cheese roll)", description:"Phyllo scrolls stuffed with feta and dill, pan fried till golden, served with cajik sauce.", category:"Appetizers", aliases:["sigara borek"] },
      { name:"mediterranean shrimp", description:"Pan seared blackened shrimp, parmesan crusted and topped with a balsamic reduction.", category:"Appetizers", aliases:[] },
      { name:"chicken fingers", description:"", category:"Appetizers", aliases:[] },
      { name:"french fries", description:"", category:"Appetizers", aliases:[] },
      { name:"side of rice or vegetables", description:"", category:"Appetizers", aliases:[] },
      { name:"side of cold vegetables for dipping", description:"", category:"Appetizers", aliases:[] },
      { name:"side of feta cheese", description:"", category:"Appetizers", aliases:[] },
      { name:"extra pita", description:"", category:"Appetizers", aliases:[] },
      { name:"tomato feta flatbread", description:"Sliced Jersey tomato with melted feta cheese, oregano, & extra virgin olive oil, baked in our brick oven.", category:"Flatbreads", aliases:[] },
      { name:"fresh mozzarella flatbread", description:"Fresh mozzarella, tomato, basil, & extra virgin olive oil, baked in our brick oven and topped with parmesan cheese.", category:"Flatbreads", aliases:[] },
      { name:"gorgonzola cheese flatbread", description:"Topped with sliced mushrooms, gorgonzola cheese, and fresh mozzarella.", category:"Flatbreads", aliases:[] },
      { name:"artichoke pesto flatbread", description:"Topped with pesto sauce, artichoke hearts, and fresh mozzarella.", category:"Flatbreads", aliases:[] },
      { name:"shepherd‚Äôs salad", description:"Tomatoes, cucumbers, green peppers, red onions, parsley, white vinegar, lemon juice, salt, pepper, and extra virgin olive oil.", category:"Salads", aliases:["shepherds salad"] },
      { name:"tahini shepherd‚Äôs salad", description:"Tomatoes, cucumbers, green peppers, red onions, parsley, lemon juice, salt, pepper, tahini sauce and extra virgin olive oil.", category:"Salads", aliases:["tahini shepherds"] },
      { name:"tabouleh salad", description:"Parsley, tomatoes, scallions, and brown wheat flavored with lemon juice and extra virgin olive oil.", category:"Salads", aliases:["tabbouleh"] },
      { name:"moroccan couscous salad", description:"Couscous mixed with tomato, green pepper, olives, diced red onion, pine nuts, and toasted almonds finished in a lemon vinaigrette, topped with jumbo shrimp.", category:"Salads", aliases:[] },
      { name:"fattoush salad", description:"Romaine lettuce, cucumber, tomatoes, and onions topped with toasted pita tossed with sumac, lemon juice and olive oil.", category:"Salads", aliases:[] },
      { name:"mediterranean salad", description:"Chopped greens with grilled chicken, roasted peppers, tomatoes, pine nuts and kalamata olives finished in balsamic vinaigrette and topped with crumbled feta cheese.", category:"Salads", aliases:[] },
      { name:"greek salad", description:"Romaine lettuce, tomatoes, cucumbers, red onion, kalamata olives, and dressed with an olive oil vinaigrette topped with feta.", category:"Salads", aliases:[] },
      { name:"soup of the day", description:"", category:"Soups", aliases:[] },
      { name:"spicy red lentil soup", description:"", category:"Soups", aliases:["red lentil"] },
      { name:"Adana Kebab (sandwich)", description:"11am‚Äì5pm; No Dinners.", category:"Sandwiches", aliases:["adana sandwich"] },
      { name:"Chicken Kebab (sandwich)", description:"11am‚Äì5pm; No Dinners.", category:"Sandwiches", aliases:["chicken kebab sandwich"] },
      { name:"Chicken Adana Kebab (sandwich)", description:"11am‚Äì5pm; No Dinners.", category:"Sandwiches", aliases:["chicken adana sandwich"] },
      { name:"Felafel (sandwich)", description:"11am‚Äì5pm; No Dinners.", category:"Sandwiches", aliases:["falafel sandwich","falafel"] },
      { name:"baba ghanoush (sandwich)", description:"11am‚Äì5pm; No Dinners.", category:"Sandwiches", aliases:[] },
      { name:"hummus (sandwich)", description:"11am‚Äì5pm; No Dinners.", category:"Sandwiches", aliases:[] },
      { name:"kesk√ºl", description:"", category:"Desserts", aliases:["keskul"] },
      { name:"baked rice pudding", description:"", category:"Desserts", aliases:[] },
      { name:"brown top pudding / kazandibi", description:"", category:"Desserts", aliases:["kazandibi"] },
      { name:"baklava", description:"", category:"Desserts", aliases:[] },
      { name:"tiramisu", description:"", category:"Desserts", aliases:[] },
      { name:"panna cotta", description:"", category:"Desserts", aliases:[] },
      { name:"tartufo ice cream", description:"", category:"Desserts", aliases:[] },
      { name:"chocolate lava cake", description:"", category:"Desserts", aliases:[] },
      { name:"san pellegrino sparkling water", description:"", category:"Beverages", aliases:["sparkling water","pellegrino"] },
      { name:"juices", description:"Mango, Guava, Cocktail Nectar, Cranberry, or Apple.", category:"Beverages", aliases:["juice"] },
      { name:"soda", description:"Coke, Diet Coke, Ginger Ale, Sprite, or Orange.", category:"Beverages", aliases:["soft drink"] },
      { name:"iced tea & lemonade", description:"Lemonade, Rosewater Iced Tea, or Rosewater Lemonade.", category:"Beverages", aliases:["iced tea","lemonade"] },
      { name:"turkish coffee", description:"single 4.00 / double 5.00", category:"Coffee & Tea", aliases:[] },
      { name:"espresso", description:"single 3.00 / double 4.00", category:"Coffee & Tea", aliases:[] },
      { name:"cappuccino", description:"", category:"Coffee & Tea", aliases:[] },
      { name:"iced cappuccino", description:"", category:"Coffee & Tea", aliases:[] },
      { name:"coffee", description:"", category:"Coffee & Tea", aliases:["drip coffee"] },
      { name:"caf√© mocha", description:"", category:"Coffee & Tea", aliases:["cafe mocha"] },
      { name:"caf√© latte", description:"", category:"Coffee & Tea", aliases:["cafe latte","latte"] },
      { name:"hot chocolate", description:"", category:"Coffee & Tea", aliases:[] },
      { name:"herbal hot teas", description:"Turkish, Green, Mint, Jasmine, or Lemon and Ginger.", category:"Coffee & Tea", aliases:["tea","herbal tea"] }
    ];

    /* -------- State -------- */
    const state = {
      experience: null,                // Excellent | Good | Not great
      highlight: null,                 // Food | Service | Atmosphere | Authenticity
      selectedTags: new Set(),         // up to 3
      tagList: [],                     // [{text,count}]
      showAllTags: false,
      reviewText: ""
    };

    /* -------- Helpers -------- */
    const qs=(s,r=document)=>r.querySelector(s);
    const qsa=(s,r=document)=>[...r.querySelectorAll(s)];
    function buildGoogleUrl(){
      if (CONFIG.googleMapsUrl) return CONFIG.googleMapsUrl;
      if (CONFIG.googlePlaceId) return `https://search.google.com/local/writereview?placeid=${encodeURIComponent(CONFIG.googlePlaceId)}`;
      return "";
    }
    const normalizeWord = w => w.toLowerCase().replace(/[()‚Äô'`]/g,"").replace(/[^a-zA-Z\u00C0-\u017F]+/g,"").trim();

    function extractKeywords(){
      const STOP = new Set(["the","and","or","with","in","our","of","a","an","to","on","for","fresh","served","sauce","light","finished","topped","mixed","house","hot","cold","single","double","baked","filet","salad","soup","sandwich","entr√©e","entrees","entree","vegetable","vegetables","over","side","rolled","diced","grilled","pan","fried","sauteed","saut√©ed","lemon","garlic","olive","oil","extra","virgin","tomato","tomatoes","pepper","peppers","capers","reduction","cheese","dill","basil","oregano","mint","jasmine","ginger","leeks","leek","rice","couscous","bulgur","burgol"]);
      const PREFER = new Set(["lamb","chicken","beef","shrimp","salmon","tilapia","eggplant","falafel","kebab","adana","shish","couscous","hummus","baklava","pita","feta","mozzarella","pesto","tabouleh","fattoush","greek","lentil","calamari","kazandibi","espresso","turkish","coffee"]);
      const KEPT_BIGRAMS = new Set(["lamb chops","short ribs","chicken adana","adana kebab","shish kebab","rice pudding","red lentil","turkish coffee","chocolate lava","fresh mozzarella"]);

      const counts = new Map();
      const inc=(t,w=1)=>counts.set(t,(counts.get(t)||0)+w);

      MENU.forEach(item=>{
        const blob = `${item.name} ${item.description||""} ${(item.aliases||[]).join(" ")}`;
        const words = blob.split(/\s+/).map(normalizeWord).filter(Boolean);
        // unigrams
        words.forEach(w=>{
          if (STOP.has(w)) return;
          if (w.length<3) return;
          const weight = PREFER.has(w)?2:1;
          inc(w, weight);
        });
        // bigrams
        for(let i=0;i<words.length-1;i++){
          const bi = `${words[i]} ${words[i+1]}`;
          if (KEPT_BIGRAMS.has(bi)) inc(bi, 3);
        }
      });

      const arr=[...counts.entries()].map(([text,count])=>({text,count}));
      arr.sort((a,b)=> b.count-a.count || a.text.localeCompare(b.text));

      // select a clean pool
      const pool=[];
      const seen=new Set();
      for(const t of arr){
        if (seen.has(t.text)) continue;
        // prefer our curated tokens or strong frequency
        if (PREFER.has(t.text) || t.text.includes(" ") || t.count>=3){
          seen.add(t.text);
          pool.push(t);
        }
        if (pool.length>=40) break;
      }
      state.tagList=pool;
    }

    function tagButtonClasses(on){
      const base = "smooth rounded-full border px-3 py-1 text-sm focus:outline-none focus-visible:ring-2 brand-ring inline-flex items-center";
      return on
        ? base + " text-white bg-[var(--brand)] border-transparent"
        : base + " border-slate-300 text-slate-700 hover:bg-slate-50";
    }

    function renderTags(){
      const wrap=qs("#tagWrap");
      wrap.innerHTML="";
      const max = state.showAllTags ? state.tagList.length : Math.min(12, state.tagList.length);
      state.tagList.slice(0,max).forEach(t=>{
        const on = state.selectedTags.has(t.text);
        const btn = document.createElement("button");
        btn.type="button";
        btn.className = tagButtonClasses(on);
        btn.setAttribute("aria-pressed", on ? "true":"false");

        const label = document.createElement("span");
        label.textContent = t.text;

        const badge = document.createElement("span");
        badge.className = on
          ? "ml-2 rounded-full px-2 py-0.5 text-xs bg-white/20 text-white"
          : "ml-2 rounded-full px-2 py-0.5 text-xs bg-slate-100 text-slate-700";
        badge.textContent = t.count;

        btn.appendChild(label);
        btn.appendChild(badge);

        btn.addEventListener("click", ()=>{
          if (!on && state.selectedTags.size>=3) return; // max 3
          on ? state.selectedTags.delete(t.text) : state.selectedTags.add(t.text);
          renderTags();
          updateReview();
        });
        wrap.appendChild(btn);
      });

      const toggleBtn = qs("#toggleMoreTags");
      if (state.tagList.length <= 12) toggleBtn.classList.add("hidden");
      else {
        toggleBtn.classList.remove("hidden");
        toggleBtn.textContent = state.showAllTags ? "Show fewer" : "Show more";
      }
    }

    function setExperience(xp){
      state.experience = xp;
      if (xp === "Not great"){
        qs("#experience").classList.add("hidden");
        const neg = qs("#negative");
        neg.classList.remove("hidden");
        neg.setAttribute("aria-hidden","false");
      } else {
        qs("#experience").classList.add("hidden");
        const pos = qs("#positive");
        pos.classList.remove("hidden");
        pos.setAttribute("aria-hidden","false");
        updateReview(); // seed
        enableGoogleLink();
      }
    }

    function chooseDishFromTags(){
      // choose a representative dish using the selected tag names
      const tags=[...state.selectedTags];
      for(const t of tags){
        const m = MENU.find(x => x.name.toLowerCase().includes(t));
        if (m) return m;
      }
      const pref=["lamb","chicken","shrimp","salmon","tilapia","falafel","hummus","eggplant","kebab","adana","shish","baklava","couscous"];
      for(const p of pref){
        const m = MENU.find(x => x.name.toLowerCase().includes(p));
        if (m) return m;
      }
      return null;
    }

    function getHighlightLine(){
      const em = CONFIG.useEmojis;
      switch(state.highlight){
        case "Food": return `The kitchen‚Äôs attention to detail really showed.${em?" üçΩ":""}`;
        case "Service": return `Service was attentive, warm, and well-timed.${em?" ü§ù":""}`;
        case "Atmosphere": return `The dining room felt calm and welcoming, perfect for conversation.${em?" üåÜ":""}`;
        case "Authenticity": return `The flavors felt thoughtful and true to the cuisine.${em?" üåç":""}`;
        default: return "";
      }
    }

    function updateReview(){
      const rName = CONFIG.restaurantName;
      const xp = state.experience || "Good";
      const opener = xp === "Excellent"
        ? `Dinner at ${rName} was excellent from start to finish.`
        : `I stopped by ${rName} and had a genuinely good experience.`;

      const picked = chooseDishFromTags();
      let dishLine="";
      if (picked){
        const desc = picked.description ? ` ‚Äî ${picked.description} ‚Äî` : "";
        dishLine = `The ${picked.name}${desc} was prepared with care and balanced flavors.`;
      } else {
        const tags=[...state.selectedTags].slice(0,2);
        dishLine = tags.length ? `Highlights included ${tags.join(" and ")} with balanced flavors.` : `Flavors were balanced and thoughtfully prepared.`;
      }

      const hl = getHighlightLine();
      const closer = xp === "Excellent" ? "Highly recommended for a relaxed, refined meal." : "I‚Äôm already looking forward to the next visit.";
      const sparkle = xp === "Excellent" && CONFIG.useEmojis ? " ‚ú®" : "";

      const text=[opener,dishLine,hl,closer+sparkle].join(" ");
      state.reviewText = text;
      qs("#reviewText").value = text;
    }

    function enableGoogleLink(){
      const a=qs("#googleLink");
      const tip=qs("#googleTip");
      const url=buildGoogleUrl();
      if (url){ a.setAttribute("href",url); tip.style.display="none"; }
      else { a.removeAttribute("href"); tip.style.display="block"; }
    }

    function copyText(txt){
      if (navigator.clipboard?.writeText) return navigator.clipboard.writeText(txt);
      const ta=document.createElement("textarea"); ta.value=txt; ta.setAttribute("readonly",""); ta.style.position="absolute"; ta.style.left="-9999px";
      document.body.appendChild(ta); ta.select(); try{ document.execCommand("copy"); }catch(e){} document.body.removeChild(ta);
      return Promise.resolve();
    }

    async function aiPolish(draft){
      const status=qs("#aiStatus");
      if (!CONFIG.aiApiKey){
        status.textContent = "AI is disabled on this page. Add CONFIG.aiApiKey for local testing or use a server proxy.";
        return;
      }
      status.textContent="Polishing‚Ä¶";
      try{
        const sys="You are a concise dining review writer. Keep 70‚Äì120 words, warm fine-dining tone, 1‚Äì2 tasteful emojis (üçΩ ü§ù üåÜ üåç ‚ú® ‚ù§Ô∏è üëç), no extreme claims, mention the restaurant by name.";
        const prompt=`Restaurant: ${CONFIG.restaurantName}
Experience level: ${state.experience}
Selected tags: ${[...state.selectedTags].join(", ") || "none"}
Highlight: ${state.highlight || "none"}
Draft:
${draft}`;
        const res=await fetch("https://api.groq.com/openai/v1/chat/completions",{
          method:"POST",
          headers:{ "Content-Type":"application/json", "Authorization":`Bearer ${CONFIG.aiApiKey}` },
          body:JSON.stringify({ model: CONFIG.aiModel, messages:[{role:"system",content:sys},{role:"user",content:prompt}], temperature:0.4, max_tokens:220 })
        });
        if(!res.ok) throw new Error("AI request failed");
        const data=await res.json();
        const txt=data?.choices?.[0]?.message?.content?.trim();
        if (txt){ qs("#reviewText").value=txt; state.reviewText=txt; status.textContent="AI suggestion applied."; }
        else { status.textContent="AI returned no text. Keeping your draft."; }
      }catch(e){ status.textContent="Couldn‚Äôt reach the AI service. Please try again or copy your draft."; }
    }

    function sendNegativeFeedback(reason){
      if (!CONFIG.negativeFeedbackEndpoint) return Promise.resolve();
      const payload = {
        restaurantName: CONFIG.restaurantName,
        timestampISO: new Date().toISOString(),
        selection: { experience: "Not great" },
        reason,
        userAgent: navigator.userAgent
      };
      return fetch(CONFIG.negativeFeedbackEndpoint,{
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body:JSON.stringify(payload),
        keepalive:true
      }).catch(()=>{});
    }

    /* -------- Init & Events -------- */
    function resetAll(){
      state.experience=null;
      state.highlight=null;
      state.selectedTags.clear();
      state.showAllTags=false;
      qs("#reviewText").value="";
      qs("#editToggle").checked=false;
      qsa(".hl").forEach(x=>x.classList.remove("!text-white","!bg-[var(--brand)]","!border-transparent"));
      qs("#aiStatus").textContent="";
      qs("#negStatus").textContent="";
      qs("#negReason").value="";
      qs("#positive").classList.add("hidden");
      qs("#negative").classList.add("hidden");
      qs("#experience").classList.remove("hidden");
      renderTags();
    }

    function init(){
      qs("#brandName").textContent = CONFIG.restaurantName;

      // Experience
      qsa("[data-exp]").forEach(b=>{
        b.addEventListener("click", ()=> setExperience(b.getAttribute("data-exp")));
      });

      // Build keyword chips
      extractKeywords();
      renderTags();
      qs("#toggleMoreTags").addEventListener("click", ()=>{
        state.showAllTags = !state.showAllTags; renderTags();
      });

      // Highlight buttons
      qsa(".hl").forEach(btn=>{
        btn.addEventListener("click", ()=>{
          qsa(".hl").forEach(x=>x.classList.remove("!text-white","!bg-[var(--brand)]","!border-transparent"));
          btn.classList.add("!text-white","!bg-[var(--brand)]","!border-transparent");
          state.highlight = btn.getAttribute("data-hl");
          updateReview();
        });
      });

      // Review edit toggle
      qs("#editToggle").addEventListener("change", e=>{
        const ta=qs("#reviewText");
        if (e.target.checked){ ta.removeAttribute("readonly"); ta.focus(); ta.setSelectionRange(ta.value.length, ta.value.length); }
        else { ta.setAttribute("readonly",""); }
      });

      // Copy
      qs("#copyBtn").addEventListener("click", async ()=>{
        await copyText(qs("#reviewText").value);
        qs("#copyStatus").textContent="Copied";
        qs("#sr-live").textContent="Copied to clipboard";
        setTimeout(()=>{ qs("#copyStatus").textContent=""; }, 1500);
      });

      // Google link
      enableGoogleLink();

      // AI polish
      qs("#aiPolishBtn").addEventListener("click", ()=> aiPolish(qs("#reviewText").value));

      // Start over
      qs("#startOverPositive").addEventListener("click", resetAll);
      qs("#startOverNegative").addEventListener("click", resetAll);

      // Negative send (simple)
      qs("#sendNegative").addEventListener("click", async ()=>{
        const reason = qs("#negReason").value.trim();
        if (!reason){ qs("#negStatus").textContent="Please add a short note."; return; }
        qs("#negStatus").textContent="Sending‚Ä¶";
        await sendNegativeFeedback(reason);
        qs("#negStatus").textContent="Thanks. Your feedback was sent to the restaurant.";
        qs("#negReason").value="";
      });
    }

    document.addEventListener("DOMContentLoaded", init);
  </script>
</body>
</html>
